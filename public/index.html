<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirvano V5.5 - Sistema Completo + Remarketing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .header p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            text-align: center;
        }

        .stat-card.highlight {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5, #f0fdf4);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .main-content {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .main-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 16px 24px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            background: #f1f5f9;
            color: #1f2937;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 24px;
        }

        .tab-content.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .file-upload {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #667eea;
            background: #f8fafc;
        }

        .file-upload input {
            display: none;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #374151;
        }

        .campaign-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s;
        }

        .campaign-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .campaign-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .campaign-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .campaign-stat {
            text-align: center;
        }

        .campaign-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .campaign-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #10b981, #059669);
            transition: width 0.3s;
        }

        .campaign-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>
                Sistema de Funis Kirvano
                <span class="version-badge">V5.5 - Remarketing</span>
            </h1>
            <p>Sistema completo de automação com remarketing em massa</p>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statsConversations">0</div>
                    <div class="stat-label">Conversas Ativas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsPix">0</div>
                    <div class="stat-label">PIX Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsFunnels">0</div>
                    <div class="stat-label">Funis Cadastrados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsPhrases">0</div>
                    <div class="stat-label">Frases Ativas</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-value" id="statsCampaigns">0</div>
                    <div class="stat-label">Campanhas Ativas</div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- TABS -->
            <div class="main-tabs">
                <button class="tab active" onclick="switchTab('dashboard')">Dashboard</button>
                <button class="tab" onclick="switchTab('funnels')">Funis</button>
                <button class="tab" onclick="switchTab('phrases')">Frases-Chave</button>
                <button class="tab" onclick="switchTab('manual')">Frases Manuais</button>
                <button class="tab" onclick="switchTab('campaigns')">🚀 Campanhas</button>
                <button class="tab" onclick="switchTab('conversations')">Conversas</button>
            </div>

            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <h2>Bem-vindo ao Sistema de Funis</h2>
                <p style="color: #6b7280; margin-top: 12px;">
                    Use as abas acima para navegar entre as funcionalidades.
                </p>
            </div>

            <!-- FUNIS TAB -->
            <div id="funnels" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Gerenciar Funis</h2>
                    <button class="btn btn-success" onclick="openCreateFunnelModal()">+ Criar Funil</button>
                </div>
                <div id="funnelsContainer">
                    <div class="empty-state">
                        <h3>Carregando funis...</h3>
                    </div>
                </div>
            </div>

            <!-- FRASES-CHAVE TAB -->
            <div id="phrases" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Frases-Chave Automáticas</h2>
                    <button class="btn btn-success" onclick="openPhraseModal()">+ Adicionar Frase</button>
                </div>
                <div id="phrasesContainer">
                    <div class="empty-state">
                        <h3>Nenhuma frase cadastrada</h3>
                        <p>Clique em "Adicionar Frase" para começar</p>
                    </div>
                </div>
            </div>

            <!-- FRASES MANUAIS TAB -->
            <div id="manual" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>Frases de Disparo Manual</h2>
                    <button class="btn btn-success" onclick="openManualTriggerModal()">+ Adicionar Frase Manual</button>
                </div>
                <div id="manualTriggersContainer">
                    <div class="empty-state">
                        <h3>Nenhuma frase manual cadastrada</h3>
                        <p>Frases manuais são disparadas quando VOCÊ envia a mensagem</p>
                    </div>
                </div>
            </div>

            <!-- CAMPANHAS TAB -->
            <div id="campaigns" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2>🚀 Campanhas de Remarketing</h2>
                    <button class="btn btn-success" onclick="openCampaignModal()">+ Nova Campanha</button>
                </div>
                <div id="campaignsContainer">
                    <div class="empty-state">
                        <h3>Nenhuma campanha ativa</h3>
                        <p>Crie uma campanha para enviar funis em massa</p>
                    </div>
                </div>
            </div>

            <!-- CONVERSAS TAB -->
            <div id="conversations" class="tab-content">
                <h2 style="margin-bottom: 20px;">Conversas e Envios</h2>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Telefone</th>
                                <th>Produto</th>
                                <th>Funil</th>
                                <th>Passo</th>
                                <th>Status</th>
                                <th>Origem</th>
                                <th>Instância</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="conversationsTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #6b7280;">
                                    Carregando conversas...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: CRIAR FUNIL -->
    <div id="createFunnelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Criar Novo Funil</div>
            <div class="form-group">
                <label class="form-label">Nome do Funil:</label>
                <input type="text" id="newFunnelName" class="form-input" placeholder="Ex: Funil Instagram">
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeCreateFunnelModal()" style="background: #e5e7eb; color: #374151;">Cancelar</button>
                <button class="btn btn-success" onclick="createNewFunnel()">Criar Funil</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ADICIONAR FRASE-CHAVE -->
    <div id="phraseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Frase-Chave</div>
            <div class="form-group">
                <label class="form-label">Frase que ativa o funil:</label>
                <input type="text" id="modalPhrase" class="form-input" placeholder="Ex: oi gaby vim pelo insta">
            </div>
            <div class="form-group">
                <label class="form-label">Funil a ser disparado:</label>
                <select id="modalPhraseFunnel" class="form-select">
                    <option value="">Selecione um funil...</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closePhraseModal()" style="background: #e5e7eb; color: #374151;">Cancelar</button>
                <button class="btn btn-success" onclick="savePhrase()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ADICIONAR FRASE MANUAL -->
    <div id="manualTriggerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Frase de Disparo Manual</div>
            <div class="form-group">
                <label class="form-label">Frase que você vai enviar:</label>
                <input type="text" id="modalManualPhrase" class="form-input" placeholder="Ex: enviar material">
            </div>
            <div class="form-group">
                <label class="form-label">Funil a ser disparado:</label>
                <select id="modalManualFunnel" class="form-select">
                    <option value="">Selecione um funil...</option>
                </select>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeManualTriggerModal()" style="background: #e5e7eb; color: #374151;">Cancelar</button>
                <button class="btn btn-success" onclick="saveManualTrigger()">Salvar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CRIAR CAMPANHA -->
    <div id="campaignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">🚀 Criar Nova Campanha</div>
            
            <div class="form-group">
                <label class="form-label">Nome da Campanha:</label>
                <input type="text" id="campaignName" class="form-input" placeholder="Ex: Remarketing Instagram">
            </div>

            <div class="form-group">
                <label class="form-label">Funil a ser enviado:</label>
                <select id="campaignFunnel" class="form-select">
                    <option value="">Selecione um funil...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Intervalo entre envios (segundos):</label>
                <input type="number" id="campaignInterval" class="form-input" value="5" min="1" max="60">
                <small style="color: #6b7280;">Recomendado: 5-10 segundos</small>
            </div>

            <div class="form-group">
                <label class="form-label">Lista de Contatos:</label>
                <div class="file-upload" onclick="document.getElementById('contactsFile').click()">
                    <input type="file" id="contactsFile" accept=".txt" onchange="handleFileUpload(event)">
                    <div id="fileUploadText">
                        <div style="font-size: 48px; margin-bottom: 12px;">📄</div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Clique para fazer upload</div>
                        <div style="font-size: 14px; color: #6b7280;">
                            Arquivo TXT com um número por linha<br>
                            Formato: 5575999999999 (DDI + DDD + Número)
                        </div>
                    </div>
                </div>
                <div id="fileInfo" style="margin-top: 12px; display: none;">
                    <div style="padding: 12px; background: #ecfdf5; border-radius: 8px; border: 1px solid #10b981;">
                        <strong style="color: #065f46;">✓ Arquivo carregado:</strong>
                        <div id="fileName" style="color: #047857; margin-top: 4px;"></div>
                        <div id="contactCount" style="color: #047857; font-size: 14px; margin-top: 4px;"></div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn" onclick="closeCampaignModal()" style="background: #e5e7eb; color: #374151;">Cancelar</button>
                <button class="btn btn-success" onclick="createCampaign()">Criar e Iniciar</button>
            </div>
        </div>
    </div>

    <script>
        let currentContacts = [];

        // ============ NAVEGAÇÃO ============
        function switchTab(tabName) {
            // Remove active de todos
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Ativa o selecionado
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Carrega dados da aba
            if (tabName === 'funnels') loadAllFunnels();
            if (tabName === 'phrases') loadPhrases();
            if (tabName === 'manual') loadManualTriggers();
            if (tabName === 'campaigns') loadCampaigns();
            if (tabName === 'conversations') loadConversations();
        }

        // ============ DASHBOARD ============
        async function loadDashboard() {
            try {
                const response = await fetch('/api/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('statsConversations').textContent = stats.active_conversations || 0;
                    document.getElementById('statsPix').textContent = stats.pending_pix || 0;
                    document.getElementById('statsFunnels').textContent = stats.total_funnels || 0;
                    document.getElementById('statsPhrases').textContent = stats.total_phrases || 0;
                    document.getElementById('statsCampaigns').textContent = stats.active_campaigns || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // ============ FUNIS ============
        async function loadAllFunnels() {
            try {
                const response = await fetch('/api/funnels');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const container = document.getElementById('funnelsContainer');
                    container.innerHTML = result.data.map(funnel => `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="font-size: 18px; color: #1f2937;">${funnel.name}</h3>
                                    <p style="font-size: 14px; color: #6b7280; margin-top: 4px;">
                                        ${funnel.steps.length} blocos configurados
                                    </p>
                                </div>
                                <button class="btn btn-primary" onclick="editFunnel('${funnel.id}')">
                                    Editar Blocos
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('funnelsContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>Nenhum funil cadastrado</h3>
                            <p>Clique em "Criar Funil" para começar</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar funis:', error);
            }
        }

        function openCreateFunnelModal() {
            document.getElementById('newFunnelName').value = '';
            document.getElementById('createFunnelModal').classList.add('active');
        }

        function closeCreateFunnelModal() {
            document.getElementById('createFunnelModal').classList.remove('active');
        }

        async function createNewFunnel() {
            const name = document.getElementById('newFunnelName').value.trim();
            
            if (!name) {
                alert('Digite o nome do funil!');
                return;
            }
            
            const id = 'PHRASE_' + name.toUpperCase().replace(/[^A-Z0-9]/g, '_').substring(0, 20) + '_' + Date.now();
            
            try {
                const response = await fetch('/api/funnels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, name, steps: [] })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Funil "${name}" criado com sucesso!`);
                    closeCreateFunnelModal();
                    loadAllFunnels();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao criar funil: ' + error.message);
            }
        }

        function editFunnel(funnelId) {
            window.location.href = `/edit-funnel.html?id=${funnelId}`;
        }

        // ============ FRASES-CHAVE ============
        async function loadPhrases() {
            try {
                const response = await fetch('/api/phrases');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const container = document.getElementById('phrasesContainer');
                    container.innerHTML = result.data.map(phrase => `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                                        "${phrase.phrase}"
                                    </div>
                                    <div style="font-size: 14px; color: #6b7280;">
                                        Dispara: ${phrase.funnelName || phrase.funnelId}
                                        ${phrase.active ? '<span class="badge badge-success">Ativa</span>' : '<span class="badge badge-error">Inativa</span>'}
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deletePhrase('${phrase.phrase}')">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('phrasesContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>Nenhuma frase cadastrada</h3>
                            <p>Clique em "Adicionar Frase" para começar</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar frases:', error);
            }
        }

        async function openPhraseModal() {
            // Carregar funis no select
            const response = await fetch('/api/funnels');
            const result = await response.json();
            
            const select = document.getElementById('modalPhraseFunnel');
            select.innerHTML = '<option value="">Selecione um funil...</option>';
            
            if (result.success) {
                result.data.forEach(funnel => {
                    select.innerHTML += `<option value="${funnel.id}">${funnel.name}</option>`;
                });
            }
            
            document.getElementById('modalPhrase').value = '';
            document.getElementById('phraseModal').classList.add('active');
        }

        function closePhraseModal() {
            document.getElementById('phraseModal').classList.remove('active');
        }

        async function savePhrase() {
            const phrase = document.getElementById('modalPhrase').value.trim().toLowerCase();
            const funnelId = document.getElementById('modalPhraseFunnel').value;
            
            if (!phrase || !funnelId) {
                alert('Preencha todos os campos!');
                return;
            }
            
            try {
                const response = await fetch('/api/phrases', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phrase, funnelId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Frase cadastrada com sucesso!');
                    closePhraseModal();
                    loadPhrases();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao salvar frase: ' + error.message);
            }
        }

        async function deletePhrase(phrase) {
            if (!confirm(`Deseja realmente excluir a frase "${phrase}"?`)) return;
            
            try {
                const response = await fetch(`/api/phrases/${encodeURIComponent(phrase)}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Frase excluída!');
                    loadPhrases();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao excluir frase: ' + error.message);
            }
        }

        // ============ FRASES MANUAIS ============
        async function loadManualTriggers() {
            try {
                const response = await fetch('/api/manual-triggers');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const container = document.getElementById('manualTriggersContainer');
                    container.innerHTML = result.data.map(trigger => `
                        <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                                        "${trigger.phrase}"
                                    </div>
                                    <div style="font-size: 14px; color: #6b7280;">
                                        Quando VOCÊ enviar isso → Dispara: ${trigger.funnelName || trigger.funnelId}
                                        ${trigger.active ? '<span class="badge badge-success">Ativa</span>' : '<span class="badge badge-error">Inativa</span>'}
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteManualTrigger('${trigger.id}')">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('manualTriggersContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>Nenhuma frase manual cadastrada</h3>
                            <p>Frases manuais são disparadas quando VOCÊ envia a mensagem</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar frases manuais:', error);
            }
        }

        async function openManualTriggerModal() {
            // Carregar funis no select
            const response = await fetch('/api/funnels');
            const result = await response.json();
            
            const select = document.getElementById('modalManualFunnel');
            select.innerHTML = '<option value="">Selecione um funil...</option>';
            
            if (result.success) {
                result.data.forEach(funnel => {
                    select.innerHTML += `<option value="${funnel.id}">${funnel.name}</option>`;
                });
            }
            
            document.getElementById('modalManualPhrase').value = '';
            document.getElementById('manualTriggerModal').classList.add('active');
        }

        function closeManualTriggerModal() {
            document.getElementById('manualTriggerModal').classList.remove('active');
        }

        async function saveManualTrigger() {
            const phrase = document.getElementById('modalManualPhrase').value.trim().toLowerCase();
            const funnelId = document.getElementById('modalManualFunnel').value;
            
            if (!phrase || !funnelId) {
                alert('Preencha todos os campos!');
                return;
            }
            
            try {
                const response = await fetch('/api/manual-triggers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phrase, funnelId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Frase manual cadastrada com sucesso!');
                    closeManualTriggerModal();
                    loadManualTriggers();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao salvar frase manual: ' + error.message);
            }
        }

        async function deleteManualTrigger(id) {
            if (!confirm('Deseja realmente excluir esta frase manual?')) return;
            
            try {
                const response = await fetch(`/api/manual-triggers/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Frase manual excluída!');
                    loadManualTriggers();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao excluir frase manual: ' + error.message);
            }
        }

        // ============ CAMPANHAS ============
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const container = document.getElementById('campaignsContainer');
                    container.innerHTML = result.data.map(campaign => {
                        const progress = campaign.totalContacts > 0 
                            ? (campaign.stats.sent / campaign.totalContacts * 100).toFixed(1) 
                            : 0;
                        
                        const statusBadge = campaign.status === 'active' 
                            ? '<span class="badge badge-success">Ativa</span>'
                            : campaign.status === 'paused'
                            ? '<span class="badge badge-warning">Pausada</span>'
                            : campaign.status === 'completed'
                            ? '<span class="badge badge-info">Concluída</span>'
                            : '<span class="badge badge-error">Cancelada</span>';
                        
                        return `
                            <div class="campaign-card">
                                <div class="campaign-header">
                                    <div class="campaign-name">${campaign.name}</div>
                                    ${statusBadge}
                                </div>
                                
                                <div class="campaign-stats">
                                    <div class="campaign-stat">
                                        <div class="campaign-stat-value">${campaign.stats.sent}</div>
                                        <div class="campaign-stat-label">Enviados</div>
                                    </div>
                                    <div class="campaign-stat">
                                        <div class="campaign-stat-value">${campaign.totalContacts}</div>
                                        <div class="campaign-stat-label">Total</div>
                                    </div>
                                    <div class="campaign-stat">
                                        <div class="campaign-stat-value">${campaign.stats.errors}</div>
                                        <div class="campaign-stat-label">Erros</div>
                                    </div>
                                </div>
                                
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                
                                <div style="font-size: 14px; color: #6b7280; margin-bottom: 16px;">
                                    <strong>Funil:</strong> ${campaign.funnelName || campaign.funnelId}<br>
                                    <strong>Progresso:</strong> ${progress}% concluído<br>
                                    <strong>Criada em:</strong> ${new Date(campaign.createdAt).toLocaleString('pt-BR')}
                                </div>
                                
                                <div class="campaign-actions">
                                    ${campaign.status === 'active' ? `
                                        <button class="btn btn-warning btn-small" onclick="pauseCampaign('${campaign.id}')">
                                            ⏸ Pausar
                                        </button>
                                    ` : ''}
                                    ${campaign.status === 'paused' ? `
                                        <button class="btn btn-success btn-small" onclick="resumeCampaign('${campaign.id}')">
                                            ▶ Retomar
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-danger btn-small" onclick="cancelCampaign('${campaign.id}')">
                                        ✖ Cancelar
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    document.getElementById('campaignsContainer').innerHTML = `
                        <div class="empty-state">
                            <h3>Nenhuma campanha ativa</h3>
                            <p>Crie uma campanha para enviar funis em massa</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar campanhas:', error);
            }
        }

        async function openCampaignModal() {
            // Carregar funis no select
            const response = await fetch('/api/funnels');
            const result = await response.json();
            
            const select = document.getElementById('campaignFunnel');
            select.innerHTML = '<option value="">Selecione um funil...</option>';
            
            if (result.success) {
                result.data.forEach(funnel => {
                    select.innerHTML += `<option value="${funnel.id}">${funnel.name}</option>`;
                });
            }
            
            // Limpar campos
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignInterval').value = '5';
            document.getElementById('contactsFile').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            currentContacts = [];
            
            document.getElementById('campaignModal').classList.add('active');
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').classList.remove('active');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                currentContacts = lines;
                
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('contactCount').textContent = `${lines.length} contatos encontrados`;
                document.getElementById('fileInfo').style.display = 'block';
            };
            reader.readAsText(file);
        }

        async function createCampaign() {
            const name = document.getElementById('campaignName').value.trim();
            const funnelId = document.getElementById('campaignFunnel').value;
            const interval = parseInt(document.getElementById('campaignInterval').value);
            
            if (!name || !funnelId || currentContacts.length === 0) {
                alert('Preencha todos os campos e faça upload da lista de contatos!');
                return;
            }
            
            if (interval < 1 || interval > 60) {
                alert('Intervalo deve ser entre 1 e 60 segundos!');
                return;
            }
            
            try {
                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        funnelId,
                        contacts: currentContacts,
                        config: {
                            interval: interval * 1000 // Converter para milissegundos
                        }
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`✅ Campanha "${name}" criada com sucesso!\n\nEnvios iniciados para ${currentContacts.length} contatos.`);
                    closeCampaignModal();
                    loadCampaigns();
                    loadDashboard();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao criar campanha: ' + error.message);
            }
        }

        async function pauseCampaign(campaignId) {
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/pause`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Campanha pausada!');
                    loadCampaigns();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao pausar campanha: ' + error.message);
            }
        }

        async function resumeCampaign(campaignId) {
            try {
                const response = await fetch(`/api/campaigns/${campaignId}/resume`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Campanha retomada!');
                    loadCampaigns();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao retomar campanha: ' + error.message);
            }
        }

        async function cancelCampaign(campaignId) {
            if (!confirm('Deseja realmente cancelar esta campanha?')) return;
            
            try {
                const response = await fetch(`/api/campaigns/${campaignId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('✅ Campanha cancelada!');
                    loadCampaigns();
                    loadDashboard();
                } else {
                    alert('❌ Erro: ' + result.error);
                }
            } catch (error) {
                alert('❌ Erro ao cancelar campanha: ' + error.message);
            }
        }

        // ============ CONVERSAS ============
        async function loadConversations() {
            try {
                const response = await fetch('/api/conversations');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const tbody = document.getElementById('conversationsTableBody');
                    tbody.innerHTML = result.data.map(conv => {
                        const statusBadge = conv.completed 
                            ? '<span class="badge badge-success">Completo</span>'
                            : conv.canceled
                            ? '<span class="badge badge-error">Cancelado</span>'
                            : conv.pixWaiting
                            ? '<span class="badge badge-warning">Aguardando PIX</span>'
                            : '<span class="badge badge-info">Em andamento</span>';
                        
                        return `
                            <tr>
                                <td>${conv.customerName || 'N/A'}</td>
                                <td>${conv.phone}</td>
                                <td>${conv.productType || 'N/A'}</td>
                                <td style="font-size: 12px;">${conv.funnelId}</td>
                                <td>${conv.stepIndex + 1}</td>
                                <td>${statusBadge}</td>
                                <td><span class="badge badge-info">${conv.source || 'kirvano'}</span></td>
                                <td>${conv.stickyInstance || 'N/A'}</td>
                                <td style="font-size: 12px;">${new Date(conv.createdAt).toLocaleString('pt-BR')}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('conversationsTableBody').innerHTML = `
                        <tr>
                            <td colspan="9" style="text-align: center; padding: 40px; color: #6b7280;">
                                Nenhuma conversa registrada
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar conversas:', error);
            }
        }

        // ============ INICIALIZAÇÃO ============
        window.onload = function() {
            loadDashboard();
            setInterval(loadDashboard, 10000); // Atualizar a cada 10 segundos
        };
    </script>
</body>
</html>
